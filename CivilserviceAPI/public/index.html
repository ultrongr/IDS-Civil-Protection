<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FIWARE Fleet - Simple Leaflet</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  html,body,#map{height:100%;margin:0}
  .panel{position:absolute;top:8px;left:8px;background:#fff;padding:6px 8px;border-radius:6px;box-shadow:0 1px 4px rgba(0,0,0,.2);font:12px system-ui}
</style>
</head>
<body>
<div id="map"></div>
<div class="panel">
  <button id="refresh">Refresh</button>
  <span id="status"></span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
 integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
const map = L.map('map', {preferCanvas:true}).setView([37.9755, 23.7348], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const typeColors = {
  ambulance:"#e6194B", fire_truck:"#f58231", police_car:"#3cb44b", patrol_car:"#469990",
  rescue_vehicle:"#911eb4", utility_van:"#42d4f4", command_vehicle:"#0099ff",
  transport_truck:"#bfef45", maintenance_vehicle:"#ffe119", emergency_response:"#f032e6",
  unknown:"#888"
};
function colorFor(t){ return typeColors[t] || typeColors.unknown; }
function randomColor(){
  const hue = Math.floor(Math.random() * 360);
  return `hsl(${hue}, 85%, 45%)`; // vivid, readable
}
const layer = L.geoJSON({type:"FeatureCollection",features:[]},{
  pointToLayer:(f,latlng)=>L.circleMarker(latlng,{
    radius:6, weight:1, color:"#222",
    fillColor: randomColor(),
    fillOpacity:.9
  }),
  onEachFeature:(f,ly)=>{
    const p=f.properties||{};
    ly.bindPopup(`<b>${p.id||""}</b><br/>
      Type: <b>${p.type||"-"}</b><br/>
      Plate: ${p.license_plate||"-"}<br/>
      Status: ${p.status||"-"}<br/>
      Speed: ${p.speed??"-"} km/h<br/>
      Updated: ${p.lastUpdated||"-"}`);
  }
}).addTo(map);

const statusEl = document.getElementById('status');
let didFit = false;

async function load(){
  statusEl.textContent = ' loading...';
  try{
    const res = await fetch('/vehicles', {cache:'no-store'});
    if(!res.ok) throw new Error(await res.text());
    const fc = await res.json();
    layer.clearLayers();
    layer.addData(fc);
    if (!didFit && layer.getLayers().length) {
        console.log('Auto-zooming to fit vehicles...');
        map.fitBounds(layer.getBounds().pad(0.1));
        didFit = true; // never auto-zoom again
    }

    statusEl.textContent = ' ok';
  }catch(e){
    console.error(e);
    statusEl.textContent = ' error';
    alert('Failed to fetch vehicles.');
  }
}
document.getElementById('refresh').onclick = load;
load();
setInterval(load, 2000); // auto-refresh
</script>
</body>
</html>
